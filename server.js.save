require('dotenv').config();
const express = require('express');
const cors = require('cors');
const axios = require('axios');
const path = require('path');
‚àë    loadContacts();
    loadCompanies();
loadProducts();

};    loadContacts();
    loadCompanies();
loadProducts();

};
const app = express();
const PORT = 3001;

// Middleware
app.use(cors());
app.use(express.json());

// Serve static files from public directory (for easy frontend development)
app.use(express.static(path.join(__dirname, 'public')));

// HubSpot API configuration
const HUBSPOT_API_BASE = 'https://api.hubapi.com';
const HUBSPOT_TOKEN = process.env.HUBSPOT_ACCESS_TOKEN;

// Validate token on startup
if (!HUBSPOT_TOKEN) {
  console.error('‚ùå ERROR: HUBSPOT_ACCESS_TOKEN not found in .env file');
  console.error('Please create a .env file and add your HubSpot Private App token');
  process.exit(1);
}

// Health check endpoint
app.get('/health', (req, res) => {
  res.json({ 
    status: 'Server is running', 
    timestamp: new Date().toISOString() 
  });
});

// GET endpoint - Fetch contacts from HubSpot
app.get('/api/contacts', async (req, res) => {
  try {
    const response = await axios.get(
      `${HUBSPOT_API_BASE}/crm/v3/objects/contacts`,
      {
        headers: {
          'Authorization': `Bearer ${HUBSPOT_TOKEN}`,
          'Content-Type': 'application/json'
        },
        params: {
          limit: 50,
          properties: 'firstname,lastname,email,phone,jobtitle,address,active_free_trial'
        }
      }
    );
    res.json(response.data);
  } catch (error) {
    console.error('Error fetching contacts:', error.response?.data || error.message);
    res.status(error.response?.status || 500).json({
      error: 'Failed to fetch contacts',
      details: error.response?.data || error.message
    });
  }
});


// GET endpoint - Fetch all deals from HubSpot
app.get('/api/deals', async (req, res) => {
  try {
    const response = await axios.get(
      `${HUBSPOT_API_BASE}/crm/v3/objects/deals`,
      {
        headers: {
          'Authorization': `Bearer ${HUBSPOT_TOKEN}`,
          'Content-Type': 'application/json'
        },
        params: {
          limit: 50,
          properties: 'dealname,amount,dealstage,closedate,pipeline'
        }
      }
    );
    res.json(response.data);
  } catch (error) {
    console.error('Error fetching deals:', error.response?.data || error.message);
    res.status(error.response?.status || 500).json({
      error: 'Failed to fetch deals',
      details: error.response?.data || error.message
    });
  }
});

// POST endpoint - Create new deal in HubSpot with optional line items
app.post('/api/deals', async (req, res) => {
  try {
    const { dealProperties, contactId, lineItems } = req.body;

    const dealResponse = await axios.post(
      `${HUBSPOT_API_BASE}/crm/v3/objects/deals`,
      {
        properties: dealProperties
      },
      {
        headers: {
          'Authorization': `Bearer ${HUBSPOT_TOKEN}`,
          'Content-Type': 'application/json'
        }
      }
    );

    const dealId = dealResponse.data.id;

    // Associate deal with contact
    if (contactId) {
      await axios.put(
        `${HUBSPOT_API_BASE}/crm/v3/objects/deals/${dealId}/associations/contacts/${contactId}/deal_to_contact`,
        {},
        {
          headers: {
            'Authorization': `Bearer ${HUBSPOT_TOKEN}`,
            'Content-Type': 'application/json'
          }
        }
      );
    }

    // Create and associate line items if provided
    if (lineItems && lineItems.length > 0) {
      const lineItemPromises = lineItems.map(async (item) => {
        const lineItemResponse = await axios.post(
          `${HUBSPOT_API_BASE}/crm/v3/objects/line_items`,
          {
            properties: {
              name: item.name,
              quantity: item.quantity.toString(),
              price: item.price.toString(),
              amount: (item.quantity * item.price).toString(),
              hs_product_id: item.productId || ''
            }
          },
          {
            headers: {
              'Authorization': `Bearer ${HUBSPOT_TOKEN}`,
              'Content-Type': 'application/json'
            }
          }
        );

        await axios.put(
          `${HUBSPOT_API_BASE}/crm/v3/objects/line_items/${lineItemResponse.data.id}/associations/deals/${dealId}/line_item_to_deal`,
          {},
          {
            headers: {
              'Authorization': `Bearer ${HUBSPOT_TOKEN}`,
              'Content-Type': 'application/json'
            }
          }
        );

        return lineItemResponse.data;
      });

      await Promise.all(lineItemPromises);
    }

    res.json(dealResponse.data);
  } catch (error) {
    console.error('Error creating deal:', error.response?.data || error.message);
    res.status(error.response?.status || 500).json({
      error: 'Failed to create deal',
      details: error.response?.data || error.message
    });
  }
});
// GET endpoint - Fetch deals associated with a specific contact
app.get('/api/contacts/:contactId/deals', async (req, res) => {
  try {
    const { contactId } = req.params;
    
    // First, get the deal associations for this contact
    const associationsResponse = await axios.get(
      `${HUBSPOT_API_BASE}/crm/v3/objects/contacts/${contactId}/associations/deals`,
      {
        headers: {
          'Authorization': `Bearer ${HUBSPOT_TOKEN}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    // If there are associated deals, fetch their full details
    if (associationsResponse.data.results && associationsResponse.data.results.length > 0) {
      const dealIds = associationsResponse.data.results.map(r => r.id);
      
      const dealsResponse = await axios.post(
        `${HUBSPOT_API_BASE}/crm/v3/objects/deals/batch/read`,
        {
          inputs: dealIds.map(id => ({ id })),
          properties: ['dealname', 'amount', 'dealstage', 'closedate', 'pipeline']
        },
        {
          headers: {
            'Authorization': `Bearer ${HUBSPOT_TOKEN}`,
            'Content-Type': 'application/json'
          }
        }
      );
      
      res.json(dealsResponse.data);
    } else {
      res.json({ results: [] });
    }
  } catch (error) {
    console.error('Error fetching deals for contact:', error.response?.data || error.message);
    res.status(error.response?.status || 500).json({
      error: 'Failed to fetch deals for contact',
      details: error.response?.data || error.message
    });
  }
});

// Start server
// POST endpoint - Create an order with line items (using Deals in Ecommerce pipeline)
app.post('/api/orders', async (req, res) => {
  try {
    const { orderData, contactId, lineItems } = req.body;

    // Calculate total from line items
    const totalAmount = lineItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);

// Map order status to ecommerce pipeline stages
    // Pipeline 830941081 stages: Completed, Processing, Shipped, Delivered
    const statusToStage = {
      'completed': '1231177262',    // Completed stage
      'processing': '1231177263',   // Processing stage
      'shipped': '1231177264',      // Shipped stage
      'delivered': '1231177265'     // Delivered stage
    };

    const dealStage = statusToStage[orderData.orderStatus] || '1231177262';

    // Step 1: Create the deal to represent the order in ecommerce pipeline
    const dealResponse = await axios.post(
      `${HUBSPOT_API_BASE}/crm/v3/objects/deals`,
      {
        properties: {
          dealname: orderData.orderName || `Order #${orderData.orderNumber}`,
          amount: totalAmount.toString(),
          dealstage: dealStage,
          pipeline: '830941081',
          closedate: new Date().toISOString().split('T')[0], // Today's date in YYYY-MM-DD,
          hs_createdate: new Date().toISOString()
        }
      },
      {
        headers: {
          'Authorization': `Bearer ${HUBSPOT_TOKEN}`,
          'Content-Type': 'application/json'
        }
      }
    );

    const dealId = dealResponse.data.id;

    // Step 2: Associate deal with contact if provided
    if (contactId) {
      await axios.put(
        `${HUBSPOT_API_BASE}/crm/v3/objects/deals/${dealId}/associations/contacts/${contactId}/deal_to_contact`,
        {},
        {
          headers: {
            'Authorization': `Bearer ${HUBSPOT_TOKEN}`,
            'Content-Type': 'application/json'
          }
        }
      );
    }

    // Step 3: Create line items and associate with deal/order
    const lineItemPromises = lineItems.map(async (item) => {
      const lineItemResponse = await axios.post(
        `${HUBSPOT_API_BASE}/crm/v3/objects/line_items`,
        {
          properties: {
            name: item.name,
            quantity: item.quantity.toString(),
            price: item.price.toString(),
            amount: (item.quantity * item.price).toString(),
            description: item.description || `${item.name} - Qty: ${item.quantity}`
          }
        },
        {
          headers: {
            'Authorization': `Bearer ${HUBSPOT_TOKEN}`,
            'Content-Type': 'application/json'
          }
        }
      );

      await axios.put(
        `${HUBSPOT_API_BASE}/crm/v3/objects/line_items/${lineItemResponse.data.id}/associations/deals/${dealId}/line_item_to_deal`,
        {},
        {
          headers: {
            'Authorization': `Bearer ${HUBSPOT_TOKEN}`,
            'Content-Type': 'application/json'
          }
        }
      );

      return lineItemResponse.data;
    });

    const createdLineItems = await Promise.all(lineItemPromises);

    res.json({
      order: dealResponse.data,
      lineItems: createdLineItems,
      message: 'Ecommerce order created successfully with line items',
      pipeline: '830941081'
    });

  } catch (error) {
    console.error('Error creating order:', error.response?.data || error.message);
    res.status(error.response?.status || 500).json({
      error: 'Failed to create order',
      details: error.response?.data || error.message
    });
  }
});
// GET endpoint - Fetch orders from ecommerce pipeline
app.get('/api/orders', async (req, res) => {
  try {
    const response = await axios.get(
      `${HUBSPOT_API_BASE}/crm/v3/objects/deals`,
      {
        headers: {
          'Authorization': `Bearer ${HUBSPOT_TOKEN}`,
          'Content-Type': 'application/json'
        },
        params: {
          limit: 100,
          properties: 'dealname,amount,dealstage,closedate,pipeline',
          archived: false
        }
      }
    );
    
    // Filter to only show deals from ecommerce pipeline 830941081
    const orders = {
      ...response.data,
      results: response.data.results.filter(deal => deal.properties.pipeline === '830941081')
    };
    
    res.json(orders);
  } catch (error) {
    console.error('Error fetching orders:', error.response?.data || error.message);
    res.status(error.response?.status || 500).json({
      error: 'Failed to fetch orders',
      details: error.response?.data || error.message
    });
  }
});

// POST endpoint - AI-powered insights
app.post('/api/ai-insights', async (req, res) => {
  try {
    const { prompt, context } = req.body;
    
    if (!prompt) {
      return res.status(400).json({ error: 'Prompt is required' });
    }

    // Check which AI API key is available
    const ANTHROPIC_KEY = process.env.ANTHROPIC_API_KEY;
    const OPENAI_KEY = process.env.OPENAI_API_KEY;

    if (!ANTHROPIC_KEY && !OPENAI_KEY) {
      return res.status(500).json({ 
        error: 'No AI API key configured. Please add ANTHROPIC_API_KEY or OPENAI_API_KEY to your .env file' 
      });
    }

    // Prepare context summary
    const contextSummary = `
You are analyzing HubSpot CRM data for a Solutions Architect.

Current Data:
- Total Contacts: ${context?.contacts?.length || 0}
- Total Deals: ${context?.deals?.length || 0}

User Question: ${prompt}

Provide actionable insights, recommendations, or analysis based on this data.
`;

    let aiResponse;

    // Use Anthropic Claude if available
    if (ANTHROPIC_KEY) {
      const anthropicResponse = await axios.post(
        'https://api.anthropic.com/v1/messages',
        {
          model: 'claude-sonnet-4-20250514',
          max_tokens: 1000,
          messages: [
            {
              role: 'user',
              content: contextSummary
            }
          ]
        },
        {
          headers: {
            'x-api-key': ANTHROPIC_KEY,
            'anthropic-version': '2023-06-01',
            'Content-Type': 'application/json'
          }
        }
      );
      
      aiResponse = anthropicResponse.data.content[0].text;
    } 
    // Otherwise use OpenAI
    else if (OPENAI_KEY) {
      const openaiResponse = await axios.post(
        'https://api.openai.com/v1/chat/completions',
        {
          model: 'gpt-4',
          messages: [
            {
              role: 'user',
              content: contextSummary
            }
          ],
          max_tokens: 1000
        },
        {
          headers: {
            'Authorization': `Bearer ${OPENAI_KEY}`,
            'Content-Type': 'application/json'
          }
        }
      );
      
      aiResponse = openaiResponse.data.choices[0].message.content;
    }

    res.json({ 
      insight: aiResponse,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('Error generating AI insights:', error.response?.data || error.message);
    res.status(error.response?.status || 500).json({
      error: 'Failed to generate AI insights',
      details: error.response?.data || error.message
    });
  }
});
// GET endpoint - Fetch companies from HubSpot
app.get('/api/companies', async (req, res) => {
  try {
    const response = await axios.get(
      `${HUBSPOT_API_BASE}/crm/v3/objects/companies`,
      {
        headers: {
          'Authorization': `Bearer ${HUBSPOT_TOKEN}`,
          'Content-Type': 'application/json'
        },
        params: {
          limit: 100,
          properties: 'name,domain'
        }
      }
    );
    res.json(response.data);
  } catch (error) {
    console.error('Error fetching companies:', error.response?.data || error.message);
    res.status(error.response?.status || 500).json({
      error: 'Failed to fetch companies',
      details: error.response?.data || error.message
    });
  }
});
// GET endpoint - Fetch products from HubSpot
app.get('/api/products', async (req, res) => {
  try {
    const response = await axios.get(
      `${HUBSPOT_API_BASE}/crm/v3/objects/products`,
      {
        headers: {
          'Authorization': `Bearer ${HUBSPOT_TOKEN}`,
          'Content-Type': 'application/json'
        },
        params: {
          limit: 100,
          properties: 'name,price,description'
        }
      }
    );
    res.json(response.data);
  } catch (error) {
    console.error('Error fetching products:', error.response?.data || error.message);
    res.status(error.response?.status || 500).json({
      error: 'Failed to fetch products',
      details: error.response?.data || error.message
    });
  }
});
const server = app.listen(PORT, () => {
  console.log('\n‚úÖ Server running successfully!');
  console.log(`üåê API available at: http://localhost:${PORT}`);
  console.log(`üìã Health check: http://localhost:${PORT}/health`);
  console.log(`üìÅ Static files served from: /public`);
  console.log('\nüí° Using hot-reload? Run: npm run dev');
  console.log('üõë To stop server: Press Ctrl+C\n');
});

// Graceful shutdown handling
const gracefulShutdown = (signal) => {
  console.log(`\n‚ö†Ô∏è  Received ${signal}, closing server gracefully...`);
  
  server.close(() => {
    console.log('‚úÖ Server closed successfully');
    console.log('üëã Goodbye!\n');
    process.exit(0);
  });

  // Force close after 10 seconds if graceful shutdown fails
  setTimeout(() => {
    console.error('‚ùå Forced shutdown after timeout');
    process.exit(1);
  }, 10000);
};

// Handle termination signals
process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
process.on('SIGINT', () => gracefulShutdown('SIGINT'));

// Handle uncaught errors
process.on('uncaughtException', (error) => {
  console.error('‚ùå Uncaught Exception:', error);
  gracefulShutdown('UNCAUGHT_EXCEPTION');
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('‚ùå Unhandled Rejection at:', promise, 'reason:', reason);
  gracefulShutdown('UNHANDLED_REJECTION');
});
