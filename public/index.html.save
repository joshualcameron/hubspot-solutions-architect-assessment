<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HubSpot Solutions Architect - Contact & Deal Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f8fa;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #ff7a59;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .section {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            color: #2d3e50;
            margin-bottom: 20px;
            font-size: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #ff7a59;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-right: 10px;
        }
        button:hover {
            background: #ff6142;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 8px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .ai-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .ai-section h2 {
            color: white;
        }
        .ai-section textarea {
            min-height: 100px;
        }
        .ai-response {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            white-space: pre-wrap;
            display: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }
        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        tr:hover {
            background: #f9f9f9;
        }
        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ HubSpot Solutions Architect Assessment</h1>
        <p class="subtitle">Contact & Deal Management with AI Assistant</p>

        <div id="statusMessage" class="status"></div>

        <div class="two-column">
            <div class="section">
                <h2>Create New Contact</h2>
                <form id="createContactForm">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input type="text" id="firstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name *</label>
                        <input type="text" id="lastName" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="phone">
                    </div>
                    <div class="form-group">
                        <label>Job Title</label>
                        <input type="text" id="jobtitle">
                    </div>
                    <div class="form-group">
                        <label>Associated Company</label>
                        <select id="contactCompanyId">
                            <option value="">None</option>
                        </select>
                    </div>
                    <button type="submit">Create Contact</button>
                </form>
            </div>


        <div class="section">
            <h2>All Contacts</h2>
            <button onclick="loadContacts()">Refresh Contacts</button>
            <div id="contactsList"></div>
        </div>

        <div class="section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h2 style="color: white;">ðŸ›’ Create Ecommerce Order (with Line Items)</h2>
            <p style="margin-bottom: 20px; opacity: 0.9;">Simulate an ecommerce order sync - creates a deal with associated line items</p>
            
            <form id="createOrderForm">
                <div class="form-group">
                    <label style="color: white;">Order Number *</label>
                    <input type="text" id="orderNumber" required placeholder="ORD-2024-001">
                </div>
                
                <div class="form-group">
                    <label style="color: white;">Customer (Contact) *</label>
                    <select id="orderContactId" required style="background: white; color: #333;">
                        <option value="">Select customer...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label style="color: white;">Order Status</label>
                    <select id="orderStatus" style="background: white; color: #333;">
                        <option value="completed">Completed</option>
                        <option value="processing">Processing</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                    </select>
                </div>

                <h3 style="color: white; margin-top: 25px; margin-bottom: 15px;">Line Items</h3>
                
                <div id="lineItemsContainer">
                    <div class="line-item" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label style="color: white;">Product Name *</label>
                            <input type="text" class="item-name" required placeholder="Product Name">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div class="form-group">
                                <label style="color: white;">Quantity *</label>
                                <input type="number" class="item-quantity" required min="1" value="1">
                            </div>
                            <div class="form-group">
                                <label style="color: white;">Price *</label>
                                <input type="number" class="item-price" required min="0" step="0.01" placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label style="color: white;">Subtotal</label>
                                <input type="text" class="item-subtotal" readonly style="background: rgba(255,255,255,0.2);" value="$0.00">
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" onclick="addLineItem()" style="background: rgba(255,255,255,0.2); margin-bottom: 15px;">+ Add Another Item</button>
                
                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; margin-top: 20px;">
                    <h3 style="color: white; margin: 0;">Total: <span id="orderTotal">$0.00</span></h3>
                </div>

                <button type="submit" style="background: #ff7a59; margin-top: 15px;">Create Order</button>
            </form>
        </div>

        <div class="section">
            <h2>ðŸ“¦ Recent Orders</h2>
            <button onclick="loadOrders()">Refresh Orders</button>
            <div id="ordersList" style="margin-top: 20px;"></div>
        </div>

        <div class="section ai-section">
            <h2>ðŸ¤– AI-Powered Contact Insights</h2>
            <div class="form-group">
                <label>Ask the AI about your contacts, deals, or get business insights:</label>
                <textarea id="aiPrompt" placeholder="Examples:
- Analyze my top contacts and suggest who to prioritize
- What deals should I follow up on?
- Create a personalized email template for enterprise customers
- Summarize my pipeline health"></textarea>
            </div>
            <button onclick="getAIInsights()">Get AI Insights</button>
            <div id="aiResponse" class="ai-response"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';

        window.onload = () => {
            loadContacts();
            loadCompanies();
            initializeOrderForm();
        };
async function loadContacts() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '<p style="color: #666;">Loading contacts...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/contacts`);
                const data = await response.json();
                const dealContactSelect = document.getElementById('dealContactId');
                
                if (data.results && data.results.length > 0) {
                    contactsList.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>First Name</th>
                                    <th>Last Name</th>
                                    <th>Job Title</th>
                                    <th>Phone Number</th>
                                    <th>Email</th>
                                    <th>Active Subscription?</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.results.map(contact => `
                                    <tr>
                                        <td>${contact.properties.firstname || '-'}</td>
                                        <td>${contact.properties.lastname || '-'}</td>
                                        <td>${contact.properties.jobtitle || '-'}</td>
                                        <td>${contact.properties.phone || '-'}</td>
                                        <td>${contact.properties.email || '-'}</td>
                                        <td id="sub-${contact.id}"><span style="color: #999;">Checking...</span></td>
                                        <td>
                                            <button onclick="viewContactOrders('${contact.id}')" style="padding: 6px 12px; font-size: 12px; background: #667eea; margin: 0;">
                                                View Orders
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    dealContactSelect.innerHTML = '<option value="">Select contact...</option>' + 
                        data.results.map(contact => `
                            <option value="${contact.id}">
                                ${contact.properties.firstname || ''} ${contact.properties.lastname || ''} (${contact.properties.email || ''})
                            </option>
                        `).join('');
                    
                    checkSubscriptionStatus(data.results);
                } else {
                    contactsList.innerHTML = '<p style="color: #666;">No contacts found. Create one above!</p>';
                }
            } catch (error) {
                contactsList.innerHTML = '<p style="color: #dc3545;">Error loading contacts.</p>';
                showStatus(`Error loading contacts: ${error.message}`, 'error');
            }
        }

        async function checkSubscriptionStatus(contacts) {
            for (const contact of contacts) {
                try {
                    const dealsResponse = await fetch(`${API_BASE}/contacts/${contact.id}/deals`);
                    const deals = await dealsResponse.json();
                    
                    const activeSubscription = deals.results?.find(deal => 
                        deal.properties.pipeline === '830876231' && 
                        deal.properties.dealstage === '1231184775'
                    );
                    
                    const cell = document.getElementById(`sub-${contact.id}`);
                    if (cell) {
                        if (activeSubscription) {
                            cell.innerHTML = `<span onclick="viewSubscriptionDetails('${activeSubscription.id}')" style="color: #28a745; font-weight: 600; cursor: pointer; text-decoration: underline;">Yes âœ“</span>`;
                        } else {
                            cell.innerHTML = `<span style="color: #dc3545;">No</span>`;
                        }
                    }
                } catch (error) {
                    const cell = document.getElementById(`sub-${contact.id}`);
                    if (cell) {
                        cell.innerHTML = `<span style="color: #dc3545;">No</span>`;
                    }
                }
            }
        }

        async function viewSubscriptionDetails(dealId) {
            try {
                const response = await fetch(`${API_BASE}/orders/${dealId}/line-items`);
                const lineItems = await response.json();
                
                if (lineItems.results && lineItems.results.length > 0) {
                    const subscriptionDetails = lineItems.results.map(item => 
                        `${item.properties.name} - $${item.properties.price || 0}`
                    ).join('\n');
                    
                    alert(`Active Subscription:\n\n${subscriptionDetails}`);
                } else {
                    alert('Subscription active, but no line item details found.');
                }
            } catch (error) {
                showStatus(`Error loading subscription details: ${error.message}`, 'error');
            }
        }

        async function loadCompanies() {
            try {
                const response = await fetch(`${API_BASE}/companies`);
                const data = await response.json();
                
                const companySelect = document.getElementById('contactCompanyId');
                if (data.results && data.results.length > 0) {
                    companySelect.innerHTML = '<option value="">None</option>' + 
                        data.results.map(company => `
                            <option value="${company.id}">
                                ${company.properties.name || 'Unnamed Company'}
                            </option>
                        `).join('');
                }
            } catch (error) {
                console.error('Error loading companies:', error);
            }
        }
        function showStatus(message, type) {
            const status = document.getElementById('statusMessage');
            status.textContent = message;
            status.className = `status ${type}`;
            setTimeout(() => {
                status.className = 'status';
            }, 5000);
        }

        document.getElementById('createContactForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const contactData = {
                properties: {
                    firstname: document.getElementById('firstName').value,
                    lastname: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    jobtitle: document.getElementById('jobtitle').value
                },
                companyId: document.getElementById('contactCompanyId').value || null
            };

            try {
                const response = await fetch(`${API_BASE}/contacts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(contactData)
                });

                if (response.ok) {
                    showStatus('Contact created successfully!', 'success');
                    e.target.reset();
                    loadContacts();
                } else {
                    const error = await response.json();
                    showStatus(`Error: ${error.message || 'Failed to create contact'}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        });

        document.getElementById('createDealForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const dealData = {
                dealProperties: {
                    dealname: document.getElementById('dealName').value,
                    amount: document.getElementById('dealAmount').value,
                    dealstage: document.getElementById('dealStage').value,
                    pipeline: document.getElementById('dealPipeline').value
                },
                contactId: document.getElementById('dealContactId').value
            };

            try {
                const response = await fetch(`${API_BASE}/deals`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dealData)
                });

                if (response.ok) {
                    showStatus('Deal created successfully!', 'success');
                    e.target.reset();
                } else {
                    const error = await response.json();
                    showStatus(`Error: ${error.message || 'Failed to create deal'}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        });
async function viewSubscriptionDetails(dealId) {
            try {
                // Get line items for the subscription deal
                const response = await fetch(`${API_BASE}/orders/${dealId}/line-items`);
                const lineItems = await response.json();
                
                if (lineItems.results && lineItems.results.length > 0) {
                    const subscriptionDetails = lineItems.results.map(item => 
                        `${item.properties.name} - $${item.properties.price || 0}`
                    ).join('\n');
                    
                    alert(`Active Subscription:\n\n${subscriptionDetails}`);
                } else {
                    alert('Subscription active, but no line item details found.');
                }
            } catch (error) {
                showStatus(`Error loading subscription details: ${error.message}`, 'error');
            }
        }
        async function loadCompanies() {
            try {
                const response = await fetch(`${API_BASE}/companies`);
                const data = await response.json();
                
                const companySelect = document.getElementById('contactCompanyId');
                if (data.results && data.results.length > 0) {
                    companySelect.innerHTML = '<option value="">None</option>' + 
                        data.results.map(company => `
                            <option value="${company.id}">
                                ${company.properties.name || 'Unnamed Company'}
                            </option>
                        `).join('');
                }
            } catch (error) {
                console.error('Error loading companies:', error);
            }
        }

        async function viewContactOrders(contactId) {
            try {
                const response = await fetch(`${API_BASE}/contacts/${contactId}/deals`);
                const deals = await response.json();
                
                const orders = deals.results ? deals.results.filter(deal => 
                    deal.properties.pipeline === '830941081'
                ) : [];                
                if (orders.length > 0) {
                    const orderDetails = orders.map(order => 
                        `${order.properties.dealname || 'Unnamed Order'} - $${order.properties.amount || 0}`
                    ).join('\n');
                    alert(`This contact has ${orders.length} order(s):\n\n${orderDetails}`);
                } else {
                    alert('No orders associated with this contact yet.');
                }
            } catch (error) {
                showStatus(`Error loading orders: ${error.message}`, 'error');
            }
        }

        function initializeOrderForm() {
            loadOrders();
            updateOrderContactDropdown();
            
            document.addEventListener('input', (e) => {
                if (e.target.classList.contains('item-quantity') || e.target.classList.contains('item-price')) {
                    calculateLineItemSubtotals();
                }
            });
        }

        async function updateOrderContactDropdown() {
            try {
                const response = await fetch(`${API_BASE}/contacts`);
                const data = await response.json();
                
                const select = document.getElementById('orderContactId');
                if (data.results && data.results.length > 0) {
                    select.innerHTML = '<option value="">Select customer...</option>' + 
                        data.results.map(contact => `
                            <option value="${contact.id}">
                                ${contact.properties.firstname || ''} ${contact.properties.lastname || ''} (${contact.properties.email || ''})
                            </option>
                        `).join('');
                }
            } catch (error) {
                console.error('Error loading contacts for orders:', error);
            }
        }
        function addLineItem() {
            const container = document.getElementById('lineItemsContainer');
            const newItem = container.querySelector('.line-item').cloneNode(true);
            
            newItem.querySelectorAll('input').forEach(input => {
                if (!input.classList.contains('item-quantity')) {
                    input.value = '';
                } else {
                    input.value = '1';
                }
            });   
            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'Ã— Remove';
            removeBtn.type = 'button';
            removeBtn.style.cssText = 'background: rgba(255,0,0,0.3); margin-top: 10px;';
            removeBtn.onclick = () => {
                newItem.remove();
                calculateLineItemSubtotals();
            };
            newItem.appendChild(removeBtn);
            
            container.appendChild(newItem);
        }

        function calculateLineItemSubtotals() {
            let total = 0;
            document.querySelectorAll('.line-item').forEach(item => {
                const quantity = parseFloat(item.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(item.querySelector('.item-price').value) || 0;
                const subtotal = quantity * price;
                
                item.querySelector('.item-subtotal').value = `$${subtotal.toFixed(2)}`;
                total += subtotal;
            });
            
            document.getElementById('orderTotal').textContent = `$${total.toFixed(2)}`;
        }

        document.getElementById('createOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const lineItems = [];
            document.querySelectorAll('.line-item').forEach(item => {
                const name = item.querySelector('.item-name').value;
                const quantity = parseInt(item.querySelector('.item-quantity').value);
                const price = parseFloat(item.querySelector('.item-price').value);
                
                if (name && quantity && price) {
                    lineItems.push({ name, quantity, price });
                }
            });

            if (lineItems.length === 0) {
                showStatus('Please add at least one line item', 'error');
                return;
            }

            const total = lineItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);

            const orderData = {
                orderData: {
                    orderNumber: document.getElementById('orderNumber').value,
                    orderName: `Order ${document.getElementById('orderNumber').value}`,
                    totalAmount: total.toFixed(2),
                    orderStatus: document.getElementById('orderStatus').value,
                    status: 'closedwon'
                },
                contactId: document.getElementById('orderContactId').value,
                lineItems: lineItems
            };

            try {
                const response = await fetch(`${API_BASE}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    showStatus('Order created successfully with line items!', 'success');
                    e.target.reset();
                    document.getElementById('orderTotal').textContent = '$0.00';
                    loadOrders();
                } else {
                    const error = await response.json();
                    showStatus(`Error: ${error.message || 'Failed to create order'}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        });

        async function loadOrders() {
            try {
                const response = await fetch(`${API_BASE}/orders`);
                const data = await response.json();
                
                const ordersList = document.getElementById('ordersList');
                
                if (data.results && data.results.length > 0) {
                    ordersList.innerHTML = data.results.map(order => `
                        <div style="border: 1px solid #e0e0e0; padding: 15px; border-radius: 6px; background: #fafafa; margin-bottom: 10px; cursor: pointer;" onclick="viewOrderDetails('${order.id}')">
                            <div style="font-weight: 600; color: #2d3e50; margin-bottom: 5px;">
                                ${order.properties.dealname || 'Unnamed Order'}
                            </div>
                            <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                Amount: $${order.properties.amount || '0'}
                            </div>
                            <div style="color: #888; font-size: 13px;">Status: Completed</div>
                        </div>
                    `).join('');
                } else {
                    ordersList.innerHTML = '<p style="color: #666;">No orders found. Create one above!</p>';
                }
            } catch (error) {
                showStatus(`Error loading orders: ${error.message}`, 'error');
            }
        }

        async function viewOrderDetails(orderId) {
            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}/line-items`);
                const lineItems = await response.json();
                
                if (lineItems.results && lineItems.results.length > 0) {
                    const details = lineItems.results.map(item => 
                        `${item.properties.name} - Qty: ${item.properties.quantity} Ã— $${item.properties.price} = $${item.properties.amount}`
                    ).join('\n');
                    alert(`Order Line Items:\n\n${details}`);
                } else {
                    alert('No line items found for this order.');
                }
            } catch (error) {
                showStatus(`Error loading order details: ${error.message}`, 'error');
            }
        }

        async function getAIInsights() {
            const prompt = document.getElementById('aiPrompt').value;
            const responseDiv = document.getElementById('aiResponse');
            
            if (!prompt) {
                showStatus('Please enter a prompt for the AI', 'error');
                return;
            }

            responseDiv.style.display = 'block';
            responseDiv.textContent = 'ðŸ¤” Thinking...';

            try {
                const [contactsRes, dealsRes] = await Promise.all([
                    fetch(`${API_BASE}/contacts`),
                    fetch(`${API_BASE}/deals`)
                ]);

                const contacts = await contactsRes.json();
                const deals = await dealsRes.json();

                const response = await fetch(`${API_BASE}/ai-insights`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        context: {
                            contacts: contacts.results || [],
                            deals: deals.results || []
                        }
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    responseDiv.textContent = result.insight || result.message;
                } else {
                    const error = await response.json();
                    responseDiv.textContent = `Error: ${error.message || 'AI request failed'}`;
                }
            } catch (error) {
                responseDiv.textContent = `Error: ${error.message}`;
            }
        }
    </script>
</body>
</html>
